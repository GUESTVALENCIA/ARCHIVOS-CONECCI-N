const SANDRA_API_URL=window.SANDRA_API_URL||'https://api.sandra.local';
const SANDRA_API_KEY=window.SANDRA_API_KEY||'REPLACE_ME';
const AVATAR_IFRAME_URL=window.AVATAR_IFRAME_URL||'about:blank';
const SandraUI={show:t=>{document.getElementById('panel-text').style.display=t==='text'?'block':'none';document.getElementById('panel-voice').style.display=t==='voice'?'block':'none';document.getElementById('panel-avatar').style.display=t==='avatar'?'block':'none';},log:(r,t)=>{const e=document.getElementById('chat-log');const l=document.createElement('div');l.style.marginBottom='6px';l.innerHTML=`<strong>${r}:</strong> ${t}`;e.appendChild(l);e.scrollTop=e.scrollHeight;},setVoiceStatus:t=>document.getElementById('voice-status').textContent=t||''};
const SandraAPI={async sendText(){const n=document.getElementById('chat-input');const m=n.value.trim();if(!m)return;SandraUI.log('TÃº',m);n.value='';try{const res=await fetch(`${SANDRA_API_URL}/chat`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${SANDRA_API_KEY}`},body:JSON.stringify({message:m})});if(!res.ok)throw new Error('HTTP '+res.status);const data=await res.json();const reply=data.reply||'(respuesta)';SandraUI.log('Sandra',reply);this.playTTS(reply);}catch(e){const demo='Hola ðŸ‘‹ Soy Sandra en modo demo. Configura SANDRA_API_URL y la API Key para conexiÃ³n real.';SandraUI.log('Sandra',demo);this.playTTS(demo);}},_media:{rec:null,chunks:[]},async startVoice(){SandraUI.setVoiceStatus('Preparando micrÃ³fono...');try{const stream=await navigator.mediaDevices.getUserMedia({audio:true});const rec=new MediaRecorder(stream);this._media.rec=rec;this._media.chunks=[];rec.ondataavailable=e=>this._media.chunks.push(e.data);rec.onstop=async()=>{const blob=new Blob(this._media.chunks,{type:'audio/webm'});SandraUI.setVoiceStatus('Enviando audio...');try{const form=new FormData();form.append('audio',blob,'input.webm');const res=await fetch(`${SANDRA_API_URL}/speech`,{method:'POST',headers:{'Authorization':`Bearer ${SANDRA_API_KEY}`},body:form});if(!res.ok)throw new Error('HTTP '+res.status);const data=await res.json();const text=data.text||'(texto)';const reply=data.reply||'(respuesta voz)';SandraUI.log('TÃº (vozâ†’texto)',text);SandraUI.log('Sandra',reply);this.playTTS(reply);SandraUI.setVoiceStatus('Listo.');}catch(e){SandraUI.setVoiceStatus('Demo voz. Conecta backend para respuesta real.');this.playTTS('Modo demo de voz activado.');}};rec.start();SandraUI.setVoiceStatus('Grabando... suelta para enviar.');}catch(e){SandraUI.setVoiceStatus('Permiso de micrÃ³fono denegado o error.');}},stopVoice(){const r=this._media.rec;if(r&&r.state!=='inactive'){r.stop();SandraUI.setVoiceStatus('Procesando audio...');}},playTTS(t){try{if(!('speechSynthesis'in window))return;const u=new SpeechSynthesisUtterance(t);u.lang='es-ES';speechSynthesis.cancel();speechSynthesis.speak(u);}catch{}},loadAvatar(){const f=document.getElementById('avatar-frame');f.src=AVATAR_IFRAME_URL;},sendAvatarCommand(c){const f=document.getElementById('avatar-frame');if(!f.contentWindow)return;f.contentWindow.postMessage({type:'sandra-command',command:c},'*');}};window.SandraAPI=SandraAPI;window.SandraUI=SandraUI;
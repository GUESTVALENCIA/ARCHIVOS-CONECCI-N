<script type="module">const HEALTH_URL="https://api.guestsvalencia.es/health",WS_ASR_URL="wss://api.guestsvalencia.es/asr/ws",CHAT_HTTP_URL="https://api.guestsvalencia.es/sandra/chat",LAUNCHER_SEL="#sandra-chat-button.sandra-floating-btn",MIC_ID="gvs-mic-float";(()=>{const e="@keyframes sandra-pulse{0%{box-shadow:0 0 0 0 rgba(0,200,150,.6)}70%{box-shadow:0 0 0 15px rgba(0,200,150,0)}100%{box-shadow:0 0 0 0 rgba(0,200,150,0)}}.animate-sandra-pulse{animation:sandra-pulse 2s infinite}";if(!document.getElementById("sandra-pulse-style")){const t=document.createElement("style");t.id="sandra-pulse-style",t.textContent=e,document.head.appendChild(t)}})();let isOnline=!1,healthTimer=null,lastPhrase=null;function setOnline(e,t){isOnline=!!t,e?.classList.toggle("animate-sandra-pulse",isOnline),e?.setAttribute("aria-label",isOnline?"Sandra conectada":"Sandra desconectada"),e&&(e.dataset.sandraOnline=String(isOnline))}async function quickWsProbe(e=1e3){return new Promise((t,a)=>{let n=!1;const o=new WebSocket(WS_ASR_URL),r=setTimeout(()=>{if(n)return;n=!0;try{o.close()}catch{}a()},e);o.onopen=()=>{if(n)return;n=!0,clearTimeout(r);try{o.close()}catch{}t(!0)},o.onerror=()=>{if(n)return;n=!0,clearTimeout(r);try{o.close()}catch{}t(!1)}})}function startHealthcheck(e){clearInterval(healthTimer);const t=async()=>{try{const t=await fetch(HEALTH_URL,{cache:"no-store"}),a=t.ok&&(await t.json().catch(()=>({}))).ok===!0,n=await quickWsProbe().catch(()=>!1);if(setOnline(e,a&&n),a&&n&&lastPhrase){await sendToSandra(lastPhrase),lastPhrase=null}}catch{setOnline(e,!1)}};t(),healthTimer=setInterval(t,15e3)}function moveLauncher(){const e=document.querySelector(LAUNCHER_SEL);e&&(document.body.appendChild(e),e.classList.remove("w-full","justify-center","mx-auto","py-4","px-6","static","relative"),e.classList.add("fixed","right-4","bottom-4","md:right-6","md:bottom-6","z-[2147483000]","shadow-lg","rounded-full"),setOnline(e,!1),startHealthcheck(e),setupMic(e))}function setupMic(e){let t=document.getElementById(MIC_ID);t||(t=document.createElement("button"),t.id=MIC_ID,t.textContent="ðŸŽ¤",Object.assign(t.style,{position:"fixed",right:"88px",bottom:"18px",width:"48px",height:"48px",borderRadius:"9999px",zIndex:"2147483000",boxShadow:"0 6px 18px rgba(0,0,0,.18)",background:"#10b981",color:"#fff",fontSize:"22px",lineHeight:"48px",textAlign:"center",cursor:"pointer",border:"none"}),document.body.appendChild(t));let a,n,o;const r=async()=>{if("true"!==e?.dataset?.sandraOnline)return void console.warn("Sandra offline");try{a=await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){return void console.warn("Permiso micro denegado",e)}o=new WebSocket(WS_ASR_URL),o.binaryType="arraybuffer",o.onopen=()=>{n=new MediaRecorder(a,{mimeType:"audio/webm;codecs=opus",audioBitsPerSecond:24e3}),n.ondataavailable=e=>{e.data?.size&&o.send(e.data)},n.start(250),t.style.background="#ef4444"},o.onmessage=async e=>{const a=JSON.parse(e.data);a.text&&(s(),lastPhrase=a.text,await sendToSandra(a.text).catch(e=>console.warn("Error Sandra",e)),lastPhrase=null)},o.onerror=()=>s(),o.onclose=()=>s()};const s=()=>{try{n&&"inactive"!==n.state&&n.stop()}catch{}try{a&&a.getTracks().forEach(e=>e.stop())}catch{}try{1===o?.readyState&&o.close()}catch{}t.style.background="#10b981"};t.addEventListener("click",()=>{"#10b981"===t.style.background?r():s()});new MutationObserver(()=>{const a="true"===e?.dataset?.sandraOnline;t.disabled=!a,t.style.opacity=a?"1":".5",a||s()}).observe(e,{attributes:!0,attributeFilter:["data-sandra-online"]})}async function sendToSandra(e){window.renderUserBubble?.(e);const t=await fetch(CHAT_HTTP_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:e})}),a=await t.json();return window.renderAssistantBubble?.(a.reply),a.reply}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",moveLauncher):moveLauncher();</script>
